# Step 2 - Network File System

We want all worker nodes, as well as the control node to all “see” the same drive at the same location using the Network File System (NFS) protocol. This way they can all share artifacts, datasets, checkpoints, logs, and experiment data in the same place.

In this example we assume the NFS server is remote, but if the single machine you already has this disk directly attached to it, then you only need NFS once you have other worker nodes.

---

## 1. Prepare the Host NFS Server (The Machine with the Big Disk you want to share)

First, you need to install the NFS kernel server and define which directory you want to share.

1. **Install the software:**

```bash
sudo apt update
sudo apt install nfs-kernel-server
```

1. **Create or choose the directory to share:**

```bash
sudo mkdir -p /mnt/nfs_share
# Adjust permissions so the client can write to it
sudo chown nobody:nogroup /mnt/nfs_share
sudo chmod 777 /mnt/nfs_share
```

1. **Configure the Exports file:**
Open `/etc/exports` in your favorite editor:

```bash
sudo nano /etc/exports
```

Add this line at the bottom (replace `client_ip` with the actual IP of your other server):
`/mnt/nfs_share client_ip(rw,sync,no_subtree_check)`
* `rw`: Read and write permissions.
* `sync`: Forces changes to be committed to disk before acknowledging (safer).

1. **Export the share and open the firewall:**

```bash
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
sudo ufw allow from client_ip to any port nfs
```

---

## 2. Prepare the Client Server (The Receiver)

Now, move to the server that needs to access the data.

1. **Install the client package:**

```bash
sudo apt update
sudo apt install nfs-common
```

1. **Create the mount point:**

```bash
sudo mkdir -p /mnt/shared_data
```

1. **Test the mount manually:**

```bash
sudo mount host_ip:/mnt/nfs_share /mnt/shared_data
```

*(Check if it worked by running `df -h`)*

---

## 3. Make it Persistent (The “Auto-Mount”)

If you reboot now, the share will disappear. To make it permanent, we edit the `/etc/fstab` file.

1. **Edit fstab:**

```bash
sudo nano /etc/fstab
```

1. **Add this line at the end:**`host_ip:/mnt/nfs_share /mnt/shared_data nfs defaults,user,exec,_netdev 0 0`
- **Note:** The `_netdev` option is crucial; it tells Ubuntu to wait until the network is up before trying to mount the drive, preventing boot delays or errors.

---

### Troubleshooting Tips

- **Permissions:** If you can see files but can’t write to them, double-check the `chown` settings on the **Host** server.
- **Connectivity:** Ensure both servers can `ping` each other. If they can’t, the mount will hang indefinitely.
- **Version Mismatch:** Ubuntu 22.04 defaults to NFSv4. If you have issues, you can force a version in fstab by changing `nfs` to `nfs4`.